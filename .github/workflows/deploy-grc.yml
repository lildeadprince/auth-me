# This is a basic workflow to help you get started with Actions

name: Deploy to Cloud Run

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service ID'
        required: true
      region:
        type: choice
        description: 'Target deployment region'
        default: 'europe-west1'
        options:
          - europe-west1
          - europe-north1
        required: true
      suffix:
        description: 'Deployment name suffix'
        default: 'server-eu-west'

env:
  GAR_BASE: ${{ secrets.GAR_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}


jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: GCP login
        id: auth
        uses: 'google-github-actions/auth@v0'
        with:
          credentials_json: ${{ secrets.GAR_JSON_KEY }}

      - name: View context attributes
        uses: actions/github-script@v5
        with:
          script: return '${{github.event.inputs.service}}'.split('').join(' '))

      - name: Deploy latest at GCR
        id: gcr_deploy
        uses: 'google-github-actions/deploy-cloudrun@v0'
        with:
          service: ${{ github.event.inputs.service }}
          region: ${{ github.event.inputs.region }}
          image: ${{ env.GAR_BASE }}/${{ secrets.GAR_REGISTRY_NAME }}/auth-me-server:latest

      - name: Expose deployment URL
        run: echo '::set-output name=deployment_url::${{ steps.gcr_deploy.outputs.url }}
